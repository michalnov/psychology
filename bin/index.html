<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>  
    <style>
        .clickable{
            width: 85%;
            margin: auto;
            margin-top: 10px; 
            border-style: solid; 
            border-width:1px; 
            border-radius:7px;
            padding: 3px;
            
        }
        #overlay {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
            cursor: pointer;
        }

        #text{
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 50px;
            color: white;
            transform: translate(-50%,-50%);
            -ms-transform: translate(-50%,-50%);
        }
        .dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
        }
        .dotErr {
            height: 15px;
            width: 15px;
            background-color: transparent;
            border-radius: 50%;
            display: inline-block;
        }
    </style>  
</head>
<body>
    <div id="overlay">
        <div id="text">najprv poziadaj o test <br>a vypln ho</div>
    </div>
    <div class="container">
        <div class="row" id="about">
            <div class="col-sm-4"><span>application status: <span class="dot" id="indicator"></span></span></div>
            <div class="col-sm-4">
                <div> 
                    <table id="headform" style="width:85%; margin:auto; margin-top: 5%;">
                        <tr>
                            <td><h4>Kluc</h4></td>
                            <td><input type="text" style="border-radius:7px" id="kluc" onchange="testUser('kluc')"><span class="dotErr" name="dotErr" id="errkluc"></span></td>
                        </tr>
                        <tr>
                            <td><h4>Vek</h4></td>
                            <td><input type="text" style="border-radius:7px" id="vek" onchange="testUser('vek')"><span class="dotErr" name="dotErr" id="errvek"></span></td>
                        </tr>
                        <tr>
                            <td><h4>Rod</h4></td>
                            <td><input type="text" style="border-radius:7px" id="rod" onchange="testUser('rod')"><span class="dotErr" name="dotErr" id="errrod"></span></td>
                        </tr>
                        <tr>
                            <td><h4>Å kola  </h4></td>
                            <td><input type="text" style="border-radius:7px" id="skola" onchange="testUser('skola')"><span class="dotErr" name="dotErr" id="errskola"></span></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td><button type="button" class="btn btn-success" style="border-radius:7px" onclick="sendForm()">Odoslat</button></td>
                        </tr>
                    </table>
                </div>
                <div style="display: none;" id="instruction">
                    <h4 style="width:95%; margin:auto;margin-top: 5%; margin-bottom: 5%;">Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of</h4>
                    <button type="button" class="btn btn-primary" style="margin-left: 25%;" onclick="selectTest()">Zacat test</button>
                </div>
                <div style="display: none;" id="selectTest">
                    <div class="clickable">
                        <p style="width:95%; margin:auto;" onclick="startTest('vztah')">Vztahy Ipsum is simply dummy text of the printing</button>
                    </div>
                    <div class="clickable">
                            <p style="width:95%; margin:auto;" onclick="startTest('zazitky')">zazitky Ipsum is simply dummy text of the printing</button>
                    </div>
                    <div class="clickable">
                            <p style="width:95%; margin:auto;" onclick="startTest('praca')">praca Ipsum is simply dummy text of the printing</button>
                    </div>
                </div>
                <!--  -->
                <div  style="display: none;" id="test">
                    <p><h4 style="width:95%; margin:auto; margin-top: 5%" id="quest"></h4></p>
                    <div class="clickable">
                        <p style="width:95%; margin:auto;" id="ans1" onclick="answer(1)"></p>
                    </div>
                    <div class="clickable">
                        <p style="width:95%; margin:auto;" id="ans2" onclick="answer(2)"></p>
                    </div>
                    <div class="clickable">
                        <p style="width:95%; margin:auto;" onclick="answer(3)">Nechcem odpovedat</p>
                    </div>
                </div>
                <div  style="display: none;" id="finish">
                    
                </div>
            </div>
            <div class="col-sm-4"></div>
        </div>
    </div>

    <script>
        function overlayOn() {
            document.getElementById("overlay").style.display = "block";
            setTimeout(overlayOff,30000);
        }
        
        function overlayOff() {
            document.getElementById("overlay").style.display = "none";
        }
    </script>

    <script>
        let host = "http://itsovy.sk:1133";
        let ping = setInterval(pingMe,7700);
        let test = {};
        let user = {};
        let userID = 0;
        let pc = 0;
        let block = false;

        class Test{
            constructor(param){
                this.auth = {
                    userid : userID,
                    testid : param.testid
                },
                this.description = param.description,
                this.questions = param.que,
                this.qcounter = 0,
                this.tlen = param.length
            }
        }

        function setErr(params) {
            document.getElementById("err"+params).style.backgroundColor = "red";
        }
        function clearErr(param) {
            if (param == null || param == undefined || param == "") {
                document.getElementById("errvek").style.backgroundColor = "transparent";
                document.getElementById("errskola").style.backgroundColor = "transparent";
                document.getElementById("errrod").style.backgroundColor = "transparent";
                document.getElementById("errkluc").style.backgroundColor = "transparent";
            } else {
                document.getElementById("err"+param).style.backgroundColor = "transparent";
            }
            
        }
        function pingMe() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("indicator").style.backgroundColor = "green";
                } else if (this.readyState == 4 && this.status != 200) {
                    document.getElementById("indicator").style.backgroundColor = "#bbb";
                }
            };
            xhttp.open("GET", host+"/ping", true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send();
        }

        function stopPing() {
            clearInterval(ping);
        }

        pingMe();
        stopPing();//just for testing

        function testUser(param) {
            let er = false;
                user.kluc = document.getElementById("kluc").value.trim();
                user.vek = document.getElementById("vek").value.trim();
                user.rod = document.getElementById("rod").value.trim();
                user.skola = document.getElementById("skola").value.trim();
            if (param == null || param == undefined) {
                clearErr();
                if (user.kluc.length != 4) {
                    setErr("kluc");
                    er = true;
                }
                if (user.vek.length != 2) {
                    setErr("vek");
                    er = true;
                }
                if (user.rod.length <= 2) {
                    setErr("rod");
                    er = true;
                }
                if (user.skola.length <= 3) {
                    setErr("skola");
                    er = true;
                }
                return er;
            }
            clearErr(param);
            if (user.kluc.length != 4 && param == "kluc") {
                setErr("kluc");
                er = true;
            } else if (user.vek.length != 2 && param == "vek") {
                setErr("vek");
                er = true;
            } else if (user.rod.length <= 2 && param == "rod") {
                setErr("rod");
                er = true;
            } else if (user.skola.length <= 3 && param == "skola") {
                setErr("skola");
                er = true;
            }
            return er;
        }

        function sendForm(){
            if (testUser()) {
                console.log("something");
                return
            } else {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    swap = JSON.parse(this.responseText)
                    userID = swap.user
                    console.log("aaaa");
                    var x = document.getElementById("headform");
                    x.style.display = "none";
                    document.getElementById("instruction").style.display = "block";

                }
            };
            xhttp.open("POST", host+"/user", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(JSON.stringify(user));
            }
            /*$.post(host+"/user", JSON.stringify(user),
            function(data, status){
                console.log(status);
                
                if (status==200) {
                    swap = JSON.parse(this.responseText)
                    userID = swap.user
                    selectTest();
                    console.log("aaaa");
                    var x = document.getElementById("headform");
                    x.style.display = "none";
                    document.getElementById("instruction").style.display = "block";
                }
            });*/         
            
            
        }

        function selectTest(){
            document.getElementById("instruction").style.display = "none";
            document.getElementById("selectTest").style.display = "block";
        }
let temptest;
        function startTest(param) {
            if (param == "vztah") {
                console.log(param);
            } else if (param == "praca") {
                console.log(param);
            } else if (param == "zazitky") {
                console.log(param);
            } else {
                return;
            }      
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    temptest = this.responseText;
                    test = JSON.parse(this.responseText);
                    loadque();
                }
            };
            xhttp.open("POST", host+"/gettest", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send("{\"test\":\""+param+"\",\"userid\":"+userID+"}");
            document.getElementById("selectTest").style.display = "none";
            document.getElementById("test").style.display = "block";
        }

        function loadque() {
            pc = Number.parseInt(pc);
            document.getElementById("quest").innerHTML = test.que[pc].text;
            document.getElementById("ans1").innerHTML = test.que[pc].ans[0].text;
            document.getElementById("ans2").innerHTML = test.que[pc].ans[1].text;
        }

        
        function answer(params) {
            if (block || pc > 14) {
                console.log("block");
                
                return
            }
            block = true;
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    setTimeout(function () {
                       block = false; 
                    },1500);
                    pc++;
                    if (pc > 14) {
                        
                    }
                    loadque();
                } else if (this.readyState == 4) {
                    block = false;
                    console.log("ans failed");
                }
                if (pc == 15) {

                }
            };
            xhttp.open("POST", host+"/answer", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send("{\"testid\":"+test.testid+",\"userid\":"+userID+",\"questionid\":"+test.que[pc].questionid+",\"answerid\":"+test.que[pc].ans[(params-1)].answerid+"}");
        }
    </script>
</body>
</html>